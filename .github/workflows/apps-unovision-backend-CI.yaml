name: Unovision Backend CI

on:
  push:
    branches:
      - main
    paths:
      - 'apps/unovision-backend/**'
  pull_request:
    branches:
      - main
    paths:
      - 'apps/unovision-backend/**'
  workflow_dispatch:

defaults:
  run:
    working-directory: ./apps/unovision-backend

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start Supabase local development setup
        run: supabase db start

      - name: Verify generated types are up to date
        run: |
          # Genera los types desde la DB local (creada desde migraciones)
          supabase gen types typescript --local > types.gen.ts
          
          # Compara ignorando espacios y cambios menores
          if ! git diff --ignore-space-at-eol --ignore-all-space --exit-code supabase/types/database.types.ts types.gen.ts; then
            echo "❌ Database types are out of date!"
            echo ""
            echo "The generated TypeScript types don't match what's committed."
            echo ""
            echo "To fix this:"
            echo "1. cd apps/unovision-backend"
            echo "2. supabase db reset (to apply all migrations)"
            echo "3. supabase gen types typescript --local > supabase/types/database.types.ts"
            echo "4. git add supabase/types/database.types.ts"
            echo "5. git commit -m 'Update database types'"
            echo ""
            echo "Differences found:"
            git diff --ignore-space-at-eol supabase/types/database.types.ts types.gen.ts
            exit 1
          fi
          echo "✅ Database types are up to date!"