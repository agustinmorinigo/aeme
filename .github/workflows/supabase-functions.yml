name: Deploy Supabase Functions

on:
  push:
    branches: ["main"]
    paths:
      - "apps/unovision-backend/supabase/functions/**"

jobs:
  # Job 1: Verificar que las validations pasaron
  verify-checks:
    runs-on: ubuntu-latest
    steps:
      - name: âœ… Verify required checks passed
        run: |
          echo "All required checks passed before merge"
          echo "This job ensures branch protection was enforced"

  # Job 2: Deploy (depende del anterior)
  deploy-functions:
    needs: verify-checks  # ğŸ‘ˆ Espera a que verifique
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20  # ğŸ‘ˆ ActualicÃ© a 20 para consistencia

      - name: ğŸ› ï¸ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.19.0  # ğŸ‘ˆ Misma versiÃ³n que en Validations

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      - name: ğŸš€ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸŒ Deploy Supabase functions
        run: |
          echo "ğŸš€ Deploying functions to Supabase..."
          supabase functions deploy --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}